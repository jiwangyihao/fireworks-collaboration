# P7.6 工作区准入清单

本清单用于在 P7.6 阶段上线前确认工作区、多仓库批量操作与配置同步能力的稳定性。所有项目需在灰度开启前完成并记录结果。

## 1. 自动化测试矩阵（必选）

| 类别 | 命令 | 说明 | 结果 |
| --- | --- | --- | --- |
| 工作区端到端 | `cargo test --test workspace -- workspace_clone_with_submodule_and_config_roundtrip` | 覆盖工作区创建→子模块克隆→批量 Clone/Fetch→状态查询→配置备份/恢复 | ✅ |
| 性能基准 | `cargo test --test workspace -- workspace_batch_clone_performance_targets -- --nocapture` | 校验 10/50/100 仓库批量 Clone 的平均延迟不超过基线 2×，并输出最新指标 | ✅ |
| 状态服务 | `cargo test --manifest-path src-tauri/Cargo.toml workspace_status_service` | 验证状态服务的配置清洗、缓存更新与自动刷新设置 | ✅ |
| 前端回归 | `pnpm test` | Vue/Pinia 单元测试，验证批量操作 UI 与状态页逻辑 | ✅ |

> 记录要求：将上述命令输出、关键日志与测试时间写入发布记录，便于审计与回溯。

## 2. 性能基准结果

| 场景 | 平均单仓库耗时 (ms) | 备注 |
| --- | --- | --- |
| 单仓库基线 | 105.55 | `count=1` 测得基线，用于计算阈值 |
| 10 仓库批量 | 15.54 | 应 ≤ 基线 × 2 |
| 50 仓库批量 | 11.24 | 应 ≤ 基线 × 2 |
| 100 仓库批量 | 10.21 | 应 ≤ 基线 × 2 |

> 建议在预生产环境重复一次性能测试，并将结果更新至本表格。

### 2.1 状态查询延迟基准

| 场景 | 总耗时 (ms) | 人均耗时 (ms) | 备注 |
| --- | --- | --- | --- |
| 单仓库基线 | 3.60 | 3.60 | `test_workspace_status_performance_targets` 输出 |
| 10 仓库批量 | 10.94 | 1.09 | 并发=4 |
| 50 仓库批量 | 54.24 | 1.08 | 并发=10 |
| 100 仓库批量 | 80.75 | 0.81 | 并发=16 |


## 3. 灰度发布计划

1. **准备阶段**（T-1 天）：
   - 确认自动化测试全部通过，完成性能基准记录；
   - 预热监控面板（任务成功率、批量时延、状态服务错误率）；
   - 通知协同团队（运维、SRE、前端）灰度窗口。
2. **灰度步骤**（当天）：
   - 10% 用户/工作区启用 → 观察 30 分钟 → 指标稳定后进入 30%；
   - 30% → 观察 60 分钟 → 指标稳定后全量；
   - 每一步执行自动化测试脚本并记录结果。
3. **收尾**：
   - 输出灰度总结、指标截图、异常处理记录；
   - 更新本清单“结果”列并归档至发布知识库。

## 4. 监控与告警

| 指标 | 阈值 | 告警动作 |
| --- | --- | --- |
| 批量任务成功率 | < 99% | 自动通知 Workspace Oncall + Slack #fwc-alerts |
| 批量 Clone p95 耗时 | > 2 × 单仓库基线 | 触发降级评估，必要时回滚 |
| 状态服务错误率 | > 1% | 检查缓存失效、文件权限或 IO 持续时间 |
| 批量任务排队时间 | > 60s | 检查并发配置 `maxConcurrentRepos`，必要时扩容 |

> 监控面板：`workspace/overview`（Grafana），包含任务、状态服务、git2 错误聚合。

## 5. 回滚预案

1. 发现异常指标（自动化测试失败或监控告警）后，立即执行：
   - 通过配置开关禁用 Workspace（`config.workspace.enabled=false`）；
   - 调用 `workspace_batch_cancel` 终止正在运行的批量任务；
   - 触发 `restore_workspace` 使用最近一次备份回滚配置。
2. 通知受影响团队，收集日志：
   - `workspace::batch`、`workspace::status`、`git2` 三类日志；
   - 任务失败摘要（`task list` 命令或事件总线）。
3. 记录回滚开始/结束时间、影响范围与根因，并更新知识库。

## 6. 手动验证（上线前最后一步）

- [ ] 使用真实工作区（≥5 仓库）执行批量 Clone → Fetch → Push，并确认任务面板展示正常；
- [ ] 在克隆仓库中手动更新子模块，执行 `update_all_submodules` 验证结果；
- [ ] 通过前端导出工作区配置、手动修改后导入并验证同步日志；
- [ ] 手动触发状态刷新（含强制刷新/缓存清空）并确认前端/后端统计一致；
- [ ] 灰度期间定期检查监控与日志，无异常后更新清单状态。

## 7. 联系人与支持

| 场景 | 负责人 | 联系方式 |
| --- | --- | --- |
| Workspace 后端 | @workspace-core | IM: workspace-core (钉钉) |
| 前端 UI | @workspace-frontend | Slack: #workspace-ui |
| 运维/灰度 | @workspace-ops | PagerDuty: FWC-WORKSPACE |

---

> 说明：清单全部打勾并归档后，可进入正式发布流程；若任一指标未达标，请先回滚并修复，再重新执行本清单。
