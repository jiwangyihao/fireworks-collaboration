# P7 阶段技术设计文档 —— 分布式协作与多仓库管理

## 1. 概述

本阶段在 MP0～P6 已完成的 git2-rs 基线、自适应 TLS 传输层、IP 池优选、代理支持、凭证管理等能力之上，引入"分布式协作与多仓库管理"能力。目标是在不破坏现有任务契约的前提下，为用户提供工作区（Workspace）管理、多仓库批量操作、子模块支持、以及团队协作配置同步等功能，使得 Fireworks Collaboration 能够真正成为团队级的 Git 协作工具。

### 1.1 背景
- 当前系统仅支持单仓库操作，用户需要重复执行相同命令来管理多个相关仓库；
- 缺少工作区概念，无法组织和管理相关联的多个仓库（如微服务架构、monorepo 拆分项目）；
- Git 子模块（Submodule）和子树（Subtree）尚未支持，限制了复杂项目的使用场景；
- 团队协作配置（如 IP 池策略、代理设置、凭证模板）需要手动在每个成员机器上配置，缺乏同步机制；
- 缺少批量操作能力（批量 clone、批量 fetch、批量 push），降低了多仓库场景的效率；
- 需要提供跨仓库的统一视图和状态监控，帮助用户快速了解整体进度。

### 1.2 目标
1. 建立工作区（Workspace）概念：支持创建、管理、导入/导出工作区配置，组织多个相关仓库；
2. 实现子模块支持：完整支持 Git Submodule 的初始化、更新、同步操作，与主仓库任务系统集成；
3. 支持多仓库批量操作：提供批量 clone、fetch、push 能力，支持并发控制和进度聚合；
4. 团队配置同步：支持导出/导入团队配置模板（IP 池、代理、凭证策略），便于团队成员快速配置；
5. 跨仓库状态监控：提供统一的工作区状态视图，展示所有仓库的分支、远程、变更状态；
6. 保障兼容性与回退：工作区功能为可选特性，不影响现有单仓库操作；配置同步支持版本管理和回退。

### 1.3 范围
- **后端 Rust**：实现 `workspace` 模块、`submodule` 支持、批量操作调度器、配置导入/导出工具；
- **配置**：扩展 `workspace-config.json` 定义工作区结构、仓库列表、团队配置模板；
- **数据落地**：标准化 `workspace.json`（工作区元数据）、`team-config-template.json`（团队配置模板）；
- **前端**：新增工作区管理界面、多仓库状态视图、批量操作面板、配置导入/导出界面；
- **文档与运维**：更新配置说明、工作区最佳实践、团队协作指南、故障排查手册。

### 1.4 不在本阶段
- Git LFS（Large File Storage）支持（P8 阶段）；
- 完整的 Monorepo 工具链集成（如 Nx、Turborepo）；
- 基于 Git Worktree 的多分支并行开发（未来阶段）；
- 跨仓库的 Merge Request / Pull Request 管理（需要 Git 托管平台 API 集成，P9 阶段）；
- 实时协作编辑功能（超出 Git 工具范畴）；
- 前端的复杂依赖图可视化（延后至 UI 专项优化阶段）。

### 1.5 成功标准
| 指标 | 目标 | 说明 |
|------|------|------|
| 工作区创建成功率 | 100% | 用户可成功创建、保存、加载工作区配置 |
| 子模块操作兼容性 | ≥95% | 支持常见子模块场景（初始化、更新、递归克隆）|
| 批量操作性能 | p95 < 2× 单仓库 | 10 个仓库的批量操作延迟不超过单仓库的 2 倍 |
| 配置同步准确性 | 100% | 导入的团队配置与导出源一致，无字段丢失 |
| 跨仓库状态刷新 | ≤3s | 工作区状态视图刷新延迟不超过 3 秒 |
| 回退能力 | ≤10s | 禁用工作区功能后，单仓库操作无影响 |

### 1.6 验收条件
1. 用户可创建工作区并添加多个仓库，工作区配置持久化到 `workspace.json`；
2. 支持 Git Submodule 的 `init`、`update`、`sync` 操作，任务事件正确关联主仓库；
3. 批量 clone 支持并发控制，进度事件聚合显示整体完成百分比；
4. 团队配置模板可导出为 JSON，其他成员导入后自动应用 IP 池、代理、凭证策略；
5. 工作区状态视图显示所有仓库的分支、远程 URL、未提交变更数量；
6. 配置变更（启用/禁用工作区、调整并发数）可热加载，影响新任务；
7. 所有新增单元/集成测试通过，现有回归测试无失败；
8. 文档、配置样例、最佳实践指南更新完毕。

### 1.7 交付物
- **代码**：`core/workspace` 模块、`core/submodule` 模块、批量操作调度器、配置导入/导出工具；
- **配置**：更新 `config.json` 添加 `workspace.*` 字段，新增 `workspace.json`、`team-config-template.json` 结构；
- **数据**：规范化工作区元数据结构（名称、仓库列表、配置继承关系）；
- **观测**：新增 `workspace_batch_operation`、`submodule_operation` 相关事件/日志与指标；
- **测试**：单元测试、批量操作集成测试、子模块场景测试、与 soak 脚本扩展；
- **文档**：P7 设计文档、工作区配置指南、团队协作最佳实践、故障排查手册；
- **前端**：工作区管理界面（Vue 组件）、多仓库状态视图、批量操作面板、配置导入/导出对话框。

### 1.8 回退策略
| 场景 | 操作 | 影响 |
|------|------|------|
| 工作区功能整体异常 | 设置 `workspace.enabled=false` | 回退到单仓库模式，工作区配置不加载 |
| 子模块操作失败 | 禁用子模块自动递归 | 用户手动管理子模块，主仓库操作不受影响 |
| 批量操作性能问题 | 降低并发数或禁用批量模式 | 回退到逐个仓库操作，保持任务成功 |
| 配置同步冲突 | 手动编辑配置文件或重新导出 | 受影响用户需重新导入，其他成员不受影响 |
| 状态视图查询超时 | 增加超时阈值或禁用实时刷新 | 手动刷新状态，不影响核心操作 |

### 1.9 关键依赖与假设
- Git 子模块依赖 `.gitmodules` 文件和 git2-rs 的子模块 API（已验证可用）；
- 工作区配置文件存储在应用数据目录，与 `config.json` 同级（复用 P4 配置加载机制）；
- 批量操作使用独立的任务调度器，与现有 `TaskRegistry` 协同但不冲突；
- 团队配置模板仅包含可序列化的配置字段，不包含敏感信息（凭证密码需单独管理）；
- 前端界面支持拖拽排序和多选操作（依赖 Vue 3 生态组件）；
- 配置导入/导出使用 JSON 格式，保持人类可读性和版本管理友好性。

### 1.10 风险概览
| 风险 | 等级 | 描述 | 缓解 |
|------|------|------|------|
| 子模块递归深度过大 | 中 | 深层嵌套子模块导致性能问题 | 限制递归深度（默认 5 层）+ 用户可配置 |
| 批量操作并发冲突 | 中 | 多仓库同时修改共享配置导致冲突 | 使用锁机制保护共享状态 + 事务式配置更新 |
| 工作区配置损坏 | 中 | 手动编辑导致 JSON 格式错误 | 自动备份 + 加载失败时提示修复或重建 |
| 团队配置版本不兼容 | 低 | 旧版本导出的配置无法在新版本导入 | 配置包含版本号 + 迁移工具 |
| 状态查询影响性能 | 低 | 大量仓库的状态查询占用 CPU/IO | 后台异步查询 + 缓存 + 可配置刷新间隔 |
| 前端界面复杂度 | 中 | 多仓库视图信息过载 | 分页 + 过滤 + 分组 + 可折叠面板 |

### 1.11 兼容与迁移
| 旧版本行为 | P7 调整 | 保证措施 |
|--------------|-----------|-----------|
| 所有操作基于单仓库 | 引入可选工作区模式 | 默认不启用工作区，现有流程不受影响 |
| 无子模块支持 | 新增子模块操作命令 | 非子模块仓库不触发子模块逻辑 |
| 无批量操作 | 新增批量命令与调度器 | 单仓库命令保持向后兼容 |
| 配置仅本地管理 | 支持配置导入/导出 | 导出格式为标准 JSON，可手动编辑 |
| 无跨仓库状态视图 | 新增工作区状态接口 | 仅在工作区启用时生效，不影响单仓库性能 |

## 2. 详细路线图

### 子阶段划分
| 阶段 | 主题 | 核心关键词 |
|------|------|------------|
| P7.0 | 工作区基础架构与配置 | Workspace 模型 / 配置加载 / 仓库列表管理 |
| P7.1 | 子模块支持与集成 | Submodule init/update/sync / 递归克隆 / 事件关联 |
| P7.2 | 批量操作调度与并发控制 | 批量 clone/fetch/push / 并发限制 / 进度聚合 |
| P7.3 | 团队配置同步与模板管理 | 配置导出/导入 / 版本控制 / 冲突解决 |
| P7.4 | 跨仓库状态监控与视图 | 状态查询 / 分支/远程/变更统计 / 缓存策略 |
| P7.5 | 前端集成与用户体验 | 工作区 UI / 批量操作面板 / 配置导入导出界面 |
| P7.6 | 稳定性验证与准入 | 集成测试 / 性能基准 / 文档完善 |

### P7.0 工作区基础架构与配置
- **目标**：建立独立的 `workspace` 基础模块，完成配置解析、仓库列表管理和测试支撑，使后续子阶段在不影响现有单仓库流程的情况下增量接入工作区功能。
- **范围**：
	- 新建 `core/workspace/{mod.rs,config.rs,model.rs,storage.rs}`，定义 `Workspace`、`RepositoryEntry`、`WorkspaceConfig` 等核心数据结构；
	- 加载 `workspace.json` 与 `config.json` 中与工作区相关的新字段（`enabled`、`maxConcurrentRepos`、`defaultTemplate` 等），支持热加载；
	- 设计仓库条目结构（路径、远程 URL、分支、标签、自定义配置继承）；
	- 预留与任务系统的接口（如 `Workspace::get_repos()`、`Workspace::add_repo()`），当前返回占位结果。
- **交付物**：
	- 模块骨架与单元测试（配置默认值、仓库增删改查、序列化/反序列化）；
	- 新增配置示例与文档说明；
	- `workspace.json` 结构草案（尚未实际加载仓库操作）。
- **依赖**：复用 P4 阶段的配置加载/热更新机制；无外部服务依赖。
- **验收**：
	- 后端可在无实际操作的情况下顺利编译、运行；
	- 新配置项缺省值不破坏现有单仓库任务；
	- 单元测试覆盖配置解析与仓库列表操作。
- **风险与缓解**：
	- 配置兼容风险 → 提供默认值并在日志中提示新字段启用状态；
	- 模块侵入度 → 通过 trait 接口与现有任务系统解耦，仅在 P7.2 进行实际接入。

### P7.1 子模块支持与集成
- **目标**：完整实现 Git Submodule 的核心操作（初始化、更新、同步），并与主仓库任务系统集成，确保子模块操作的进度和错误能够正确上报。
- **范围**：
	- 实现 `submodule_init`、`submodule_update`、`submodule_sync` 命令，调用 git2-rs 的子模块 API；
	- 支持递归克隆（`--recurse-submodules`），在克隆主仓库后自动初始化和更新子模块；
	- 构建子模块进度跟踪器，将子模块操作进度映射到主任务进度（如主仓库 0-50%，子模块 50-100%）；
	- 设计子模块错误分类和上报机制，区分主仓库错误和子模块错误；
	- 实现子模块状态查询接口，返回子模块列表、URL、当前提交等信息。
- **交付物**：
	- 子模块操作命令与单元测试（init、update、sync、递归克隆）；
	- 子模块进度事件与错误事件扩展；
	- 子模块操作的结构化日志与 debug 事件。
- **依赖**：依赖 P7.0 的工作区模型（子模块可关联到工作区仓库）；git2-rs 子模块 API。
- **验收**：
	- 克隆包含子模块的仓库时，子模块自动初始化和更新（可配置禁用）；
	- 子模块操作进度正确映射到任务进度事件；
	- 子模块操作失败时错误分类准确，不影响主仓库状态；
	- 子模块状态查询返回准确信息。
- **风险与缓解**：
	- 子模块递归深度过大 → 限制默认递归深度（5 层）并提供配置选项；
	- 子模块 URL 无效导致克隆失败 → 错误提示包含子模块名称和 URL，便于排查；
	- 子模块与主仓库凭证不一致 → 支持为子模块指定独立凭证（复用 P6 凭证存储）。

### P7.2 批量操作调度与并发控制
- **目标**：为工作区中的多个仓库提供批量 clone、fetch、push 能力，支持并发控制和进度聚合，提升多仓库场景的操作效率。
- **范围**：
	- 实现批量操作调度器，支持并发数控制（默认 3，可配置）；
	- 扩展任务系统，支持"父任务-子任务"模型，父任务聚合子任务进度；
	- 实现批量 clone：遍历工作区仓库列表，为每个仓库创建子任务，并发执行；
	- 实现批量 fetch 和 batch push，复用批量调度器逻辑；
	- 设计进度聚合策略：父任务进度 = 所有子任务进度的加权平均；
	- 支持部分失败容忍：某些仓库操作失败不阻塞其他仓库，最终报告失败列表。
- **交付物**：
	- 批量操作调度器与单元测试（并发控制、进度聚合、部分失败）；
	- 批量操作命令（`workspace_batch_clone`、`workspace_batch_fetch`、`workspace_batch_push`）；
	- 批量操作的父任务和子任务事件结构。
- **依赖**：依赖 P7.0 的工作区模型和 P7.1 的子模块支持；任务系统需扩展支持父子任务。
- **验收**：
	- 批量 clone 10 个仓库时，并发数受控于配置（如 3 并发，分批执行）；
	- 父任务进度事件正确聚合子任务进度，前端可显示整体进度条；
	- 部分仓库失败时，父任务状态为 `completed_with_errors`，包含失败列表；
	- 批量操作可取消，取消后所有未完成的子任务停止。
- **风险与缓解**：
	- 并发过高导致网络拥塞 → 默认并发数保守（3），提供配置选项；
	- 进度聚合不准确 → 每个子任务权重相同（简化实现），未来可支持按仓库大小加权；
	- 子任务错误淹没其他信息 → 父任务事件包含失败摘要，详细错误在子任务事件中。

### P7.3 团队配置同步与模板管理
- **目标**：支持团队配置模板的导出和导入，便于团队成员快速应用统一的 IP 池、代理、凭证策略，减少重复配置工作。
- **范围**：
	- 实现配置导出接口：将当前 `config.json` 中的 IP 池、代理、TLS 等配置导出为 `team-config-template.json`；
	- 实现配置导入接口：读取模板文件并合并到当前配置，支持字段级别的覆盖策略；
	- 支持配置版本管理：模板包含版本号和兼容性标记，导入时检查版本；
	- 设计冲突解决策略：用户可选择"覆盖本地"、"保留本地"、"合并"；
	- 实现敏感信息过滤：导出时自动排除密码、密钥等敏感字段，仅保留策略配置；
	- 支持模板部分导入：用户可选择仅导入 IP 池配置或仅导入代理配置。
- **交付物**：
	- 配置导出/导入命令与单元测试（版本检查、冲突解决、敏感信息过滤）；
	- `team-config-template.json` 结构定义和示例文件；
	- 配置导入/导出的结构化日志和事件。
- **依赖**：依赖 P4/P5/P6 的配置结构；配置加载机制需支持部分更新。
- **验收**：
	- 导出的模板文件不包含密码等敏感信息；
	- 导入模板后，IP 池、代理配置自动应用，任务使用新配置；
	- 版本不兼容时提示用户升级或手动调整；
	- 冲突解决策略按用户选择执行，日志记录覆盖的字段。
- **风险与缓解**：
	- 模板版本不兼容 → 提供迁移工具或向后兼容处理；
	- 导入导致配置损坏 → 自动备份当前配置，支持一键回滚；
	- 敏感信息泄漏 → 导出前多重检查，单元测试覆盖所有敏感字段。

### P7.4 跨仓库状态监控与视图
- **目标**：为工作区提供统一的状态查询接口和视图，展示所有仓库的分支、远程 URL、未提交变更等信息，帮助用户快速了解整体状态。
- **范围**：
	- 实现仓库状态查询接口：返回当前分支、远程 URL、未提交文件数、未推送提交数等；
	- 设计状态缓存策略：首次查询时收集状态并缓存，支持手动刷新和定时刷新；
	- 实现批量状态查询：并发查询工作区所有仓库状态，聚合返回；
	- 支持状态过滤和排序：按分支、变更状态、仓库名称排序；
	- 设计状态变更通知：检测到仓库状态变化时发送事件（可选功能）。
- **交付物**：
	- 状态查询接口与单元测试（缓存、并发、过滤）；
	- 状态查询的结构化事件和日志；
	- 状态缓存的 TTL 和刷新策略配置。
- **依赖**：依赖 P7.0 的工作区模型；git2-rs 的状态查询 API。
- **验收**：
	- 查询 10 个仓库状态的延迟 <3 秒；
	- 状态缓存在 TTL 内复用，不重复查询文件系统；
	- 状态过滤和排序功能正常，前端可按需展示；
	- 状态刷新手动触发或定时触发（可配置间隔）。
- **风险与缓解**：
	- 大量仓库查询导致性能问题 → 限制并发查询数、增加缓存 TTL；
	- 状态不准确（缓存过期）→ 提供手动刷新按钮，前端显示缓存时间；
	- 文件系统 IO 阻塞 → 使用异步查询，避免阻塞主线程。

### P7.5 前端集成与用户体验
- **目标**：为工作区、批量操作、配置同步等后端功能提供完整的前端界面，确保用户可以便捷地管理工作区和执行批量操作。
- **范围**：
	- 实现工作区管理界面：创建/删除/编辑工作区，添加/移除仓库，拖拽排序；
	- 实现多仓库状态视图：表格或卡片展示所有仓库状态，支持过滤和排序；
	- 实现批量操作面板：选择仓库、选择操作类型（clone/fetch/push）、配置并发数、执行并显示进度；
	- 实现配置导入/导出界面：选择导出字段、上传模板文件、选择冲突解决策略；
	- 优化用户体验：加载状态、错误提示、操作确认对话框、快捷键支持；
	- 集成事件订阅：监听工作区事件、批量操作事件、配置同步事件，实时更新 UI。
- **交付物**：
	- 工作区管理组件（Vue）与单元测试；
	- 多仓库状态视图组件与单元测试；
	- 批量操作面板组件与单元测试；
	- 配置导入/导出对话框组件与单元测试；
	- Pinia Store 扩展（工作区状态管理）。
- **依赖**：依赖 P7.0-P7.4 的后端接口；Vue 3 生态组件（如拖拽、表格）。
- **验收**：
	- 用户可通过 UI 创建工作区并添加仓库，操作流畅无卡顿；
	- 批量操作进度实时显示，部分失败时明确标记失败仓库；
	- 配置导入界面提示版本兼容性，导入后配置立即生效；
	- 状态视图支持手动刷新和自动刷新（可配置间隔）；
	- 所有组件通过单元测试和 E2E 测试。
- **风险与缓解**：
	- 界面复杂度高 → 分阶段实现，优先核心功能，逐步优化 UX；
	- 大量仓库导致渲染性能问题 → 虚拟滚动、分页、懒加载；
	- 事件订阅导致内存泄漏 → 组件卸载时取消订阅，单元测试覆盖。

### P7.6 稳定性验证与准入
- **目标**：通过集成测试、性能基准测试和文档完善，验证工作区和批量操作功能在实际场景中的稳定性和性能，为生产灰度提供准入结论。
- **范围**：
	- 扩展集成测试：覆盖工作区创建、子模块操作、批量操作、配置同步的端到端场景；
	- 设计性能基准测试：测量 10/50/100 个仓库的批量 clone 延迟、状态查询延迟；
	- 定义准入阈值（批量操作性能、配置同步准确性、状态刷新延迟）并编写自动化报告；
	- 与运维协作制定灰度计划、监控看板与手动回滚手册；
	- 汇总测试数据，形成最终 P7 阶段 readiness review 结论，输出到技术设计与运维文档。
- **交付物**：
	- 集成测试套件扩展（工作区、批量操作、配置同步）；
	- 性能基准测试脚本与报告模板；
	- 准入 checklist 文档，包含触发步骤与预期结果；
	- Readiness review 会议纪要与上线建议（包含灰度范围、监控项、回滚条件）。
- **依赖**：依赖 P7.0-P7.5 功能完整并在测试环境可用；需要 CI 环境支持多仓库场景测试。
- **验收**：
	- 集成测试覆盖所有核心场景，成功率 ≥99%；
	- 性能基准测试显示批量操作延迟符合目标（p95 < 2× 单仓库）；
	- 准入报告明确给出上线/灰度建议与需要关注的风险项；
	- 灰度开关演练通过（启用、禁用、回滚全程 <10 分钟）。
- **风险与缓解**：
	- 测试环境与生产环境差异 → 在预生产环境进行最终验证；
	- 准入阈值过严导致延迟上线 → 分阶段设定基线/目标值；
	- 协同团队时间冲突 → 提前预约评审窗口，准备异步报告。

## 3. 实现说明

以下章节预留给后续交付后的实现复盘，结构对齐 P4 文档。每个子阶段完成后请在对应小节补充：
- 关键代码路径与文件列表；
- 实际交付与设计差异；
- 验收/测试情况与残留风险；
- 运维手册或配置样例的落地状态。

### P7.0 工作区基础架构与配置 实现说明
（待实现后补充）

### P7.1 子模块支持与集成 实现说明
（待实现后补充）

### P7.2 批量操作调度与并发控制 实现说明
（待实现后补充）

### P7.3 团队配置同步与模板管理 实现说明
（待实现后补充）

### P7.4 跨仓库状态监控与视图 实现说明
（待实现后补充）

### P7.5 前端集成与用户体验 实现说明
（待实现后补充）

### P7.6 稳定性验证与准入 实现说明
（待实现后补充）
